filter {
  if [@metadata][stage] in ["bro_network", "bro_file", "bro_netcontrol", "bro_detection", "bro_obervations", "bro_miscellaneous", "bro_diagnostic"] {
    mutate {  add_field => { "[event][type]" => "bro-%{[event][module]}-%{[event][category]}"} }

    mutate {
      replace   => { "[@metadata][stage]" => "bro_ecs_enriched" }
    }

    # remove fields with empty values
    # ruby {
    #   code => "
    #     def walk_hash(parent, path, hash)
    #       path << parent if parent
    #       hash.each do |key, value|
    #         walk_hash(key, path, value) if value.is_a?(Hash)
    #         @paths << (path + [key]).map {|p| '[' + p + ']' }.join('')
    #       end
    #       path.pop
    #     end
    #
    #     @paths = []
    #     walk_hash(nil, [], event.to_hash)
    #
    #     @paths.each do |path|
    #       value = event.get(path)
    #       event.remove(path) if value.nil? || (value.respond_to?(:empty?) && value.empty?)
    #     end
    #   "
    # }
  }
}
