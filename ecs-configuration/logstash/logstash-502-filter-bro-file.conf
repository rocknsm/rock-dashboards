filter {
  if [@metadata][stage] == 'bro_tagged_json' {

    if [event][category] in ["pe", "x509", "files"] {

      if [@metadata][ENABLE_BRO_FILES] == false {
        # Configuration has disabled bro files events
        drop { }
      }

      mutate {
        rename => {
          "[pe][id]"    => "[event][id]"
          "[x509][id]"  => "[event][id]"
          "[files][id]" => "[event][id]"
        }
        merge => {
          "[event][id]" => "[related][id]"
        }
        add_field => {
          "[event][module]" => "file"
          "[@metadata][stage]" => "bro_file"
        }
      } # mutate
    }
  }
}
