filter {
  if [@metadata][stage] == 'bro_category' {

    if [event][category] in ["pe", "x509", "files"] {

      if ![@metadata][ENABLE_BRO_FILES] {
        # Configuration has disabled bro files events
        drop { }
      }

      mutate {
        rename => {
          "[pe][id]"    => "[event][id]"
          "[x509][id]"  => "[event][id]"
          "[files][id]" => "[event][id]"
        }
        merge => {
          "[event][id]" => "[related][id]"
        }
        add_field => { "[event][module]"   => "file" }
        replace =>   { "[@metadata][stage]" => "bro_file" }

      } # mutate

      if [file] {
        mutate {
          rename => {
            "[file][is_orig]" => "[file][is_originating]"
            "[file][local_orig]" => "[file][local_origin]"
            "[file][rx_hosts]" => "[file][receiving_hosts]"
            "[file][tx_hosts]" => "[file][transmitting_hosts]"
            "[file][conn_uids]" => "[file][network][ids]"
            "[file][timedout]" => "[file][timed_out]"
          }
        }

        mutate { merge => { "[related][hash]" => "[file][md5]" }}
        mutate { merge => { "[related][hash]" => "[file][sha1]" }}
        mutate { merge => { "[related][hash]" => "[file][sha256]" }}
        mutate { merge => { "[related][hash]" => "[file][sha512]" }}

        mutate { merge => { "[related][ip]" => "[file][receiving_hosts]" }}
        mutate { merge => { "[related][ip]" => "[file][transmitting_hosts]" }}

        mutate { merge => { "[related][id]" => "[file][network][ids]" }}

      }
    }
  }
}
