filter {
  if [@metadata][stage] == 'bro_tagged_json' {

    if [event][category] in ["conn", "dce_rpc", "dhcp", "dnp3", "dns", "ftp", "http", "irc", "kerberos", "modbus", "modbus_register_change", "mysql", "ntml", "radius", "rdp", "rfb", "sip", "smb_cmd", "smb_files", "smb_mapping", "smtp", "snmp", "socks", "ssh", "ssl", "syslog", "tunnel"] {

      ruby {
        code => '
        # This code loops through the event and moves out the IPs, Ports, and UIDs
        # This list of streams needs to be the same list as the event category above
        streams = ["conn", "dce_rpc", "dhcp", "dnp3", "dns", "ftp", "http", "irc", "kerberos", "modbus", "modbus_register_change", "mysql", "ntml", "radius", "rdp", "rfb", "sip", "smb_cmd", "smb_files", "smb_mapping", "smtp", "snmp", "socks", "ssh", "ssl", "syslog", "tunnel"]

        streams.each do |stream|
          if event.has_key? stream
            event.merge!({
              "event" => { "id" => event["#{stream}"]["uid"] },
              "network" => {
                "client" => {
                  "ip" => event["#{stream}"]["id_orig_h"],
                  "port" => event["#{stream}"]["id_orig_p"]
                },
                "server" => {
                  "ip" => event["#{stream}"]["id_resp_h"],
                  "port" => event["#{stream}"]["id_resp_p"]
                }
              }
            })
            event["#{stream}"] = event["#{stream}"].select{|x| !["uid", "id_orig_h", "id_orig_p", "id_resp_h", "id_resp_p"].include?(x)}
          end
        end
        '
      }

      # Format data types
      mutate {
        convert => {
          "[network][client][port]" => "integer"
          "[network][client][port]" => "integer"
        }

        # Related data
        merge => {
          "[related][ip]" => "[network][client][ip]"
          "[related][ip]" => "[network][server][ip]"
          "[related][id]" => "[event][id]"
        }
      }

      mutate {
        add_field => {
          "[event][module]" => "network"
          "[@metadata][stage]" => "bro_network"
        }
      } # mutate
    }
  }
}
