filter {
  if [@metadata][stage] == 'bro_json' {
    # Set the timestamp
    date { match => [ "ts", "ISO8601" ] }

    # move metadata to new field
    mutate {
      rename => {
        "@stream" => "[event][category]"
        "@system" => "[event][system]"
        "@proc"   => "[event][bro][process]"
      }
      # Clean these up later if empty
      add_field => { "[related][hostname]" => []}
      add_field => { "[related][ip]" => []}
      add_field => { "[related][id]" => []}
      add_field => { "[related][hash]" => []}
    }

    # Nest the entire document
    ruby {
      code => "
        require 'logstash/event'

        logtype = event.get('[event][category]')

        # For ECS compatibility
        if logtype == 'files'
          logtype = 'file'
        end
        ev_hash = event.to_hash
        event_hash = ev_hash['event']
        timestamp = ev_hash['@timestamp']

        # Cleanup duplicate info
        ev_hash.delete('event')
        ev_hash.delete('@timestamp')
        ev_hash.delete('@version')
        ev_hash.delete('tags')

        result = {
        logtype => ev_hash,
        'event' => event_hash,
        '@timestamp' => timestamp
        }
        event.initialize( result )
      "
    }

    mutate { replace => { "[@metadata][stage]" => "bro_category" } }

  }
}
