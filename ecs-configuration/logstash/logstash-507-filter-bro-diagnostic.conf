filter {
  if [@metadata][stage] == 'bro_tagged_json' {

    if [event][category] in [ "capture_loss", "cluster", "communication", "loaded_scripts", "packet_filter", "prof", "reporter", "stats", "stderr", "stdout" ]{

      if [@metadata][ENABLE_BRO_DIAG] == false {
        # Configuration has disabled bro diagnostic event
        drop { }
      }

      mutate {
        add_field => {
          "[event][module]" => "diagnostic"
          "[@metadata][stage]" => "bro_diagnostic"
        }
      } # mutate
    }
  }
}
